# Gemini File Search Chatbot Plugin

このプラグインは、WordPress 管理画面とウェブページに Google Gemini API（gemini-2.5-flash）ベースのチャットボットを追加するものです。管理画面でアップロードしたファイル（PDFや画像など）を Gemini File Search に保存し、その内容や手動 FAQ を参照しながら自然言語の質問に回答します。

## 主な特徴

| 項目 | 説明 |
| --- | --- |
| RAG チャット | アップロード済みファイルを File Search で検索し、生成モデルを使って回答。Gemini 最新モデルを採用。 |
| 手動回答の自動選択 | Gemini で候補を絞り込み、意味的に合致する手動回答を優先表示。なければ自動生成。 |
| アップロード処理 | ファイルをストアに直接アップロードし、Operation の完了を待ってから一覧に追加。失敗時はローカルファイルを削除。 |
| ファイル削除 | ファイル単体 / 全削除いずれも Gemini 上のドキュメントを消した後、ローカルパスとキャッシュを一貫してクリーンアップ。 |
| API制限の安全装置 | 429/503 発生時は 60 秒のトランジェントを立ててチャットフォームを一時停止し、ユーザーに「混雑中」の文言を表示。 |
| セッション & ログ | 匿名の Cookie セッション、チャットログ（未回答フラグ付き）、手動回答テーブルを保持。 |

## 要件

* WordPress 6.0 以上
* PHP 7.4 以上
* Google Cloud アカウントと Gemini API キー（gemini-2.5-flash へのアクセス権）

## インストール / 有効化

1. リポジトリを `wp-content/plugins/chatbot` に配置。
2. WordPress 管理画面 → プラグインから「Gemini File Search Chatbot」を有効化。
3. 初回有効化時にカスタムテーブル（`wp_chat_sessions`、`wp_chat_messages`、`wp_manual_answers`）が自動作成されます。
4. `Update URI: false` を設定済みなので、無効化中も WordPress が外部アップデートを確認しません。

## 管理画面の主な操作

### 1. API キーの登録
管理画面「Gemini Chatbot」→「API キー」に進み、Google AI Studio などで取得した API キーを登録します。UI 上では保存済みキーはマスク表示されます。

### 2. ストアの作成 / 再作成
「ストア管理」セクションで任意の名前を入力して File Search Store を作成／再作成し、現在のストアとして保存します。ストアは複数作成できますが、現在利用するストア名が記録されます。

### 3. ファイルアップロード
「ファイルアップロード」タブで PDF や画像ファイルを選択し、Gemini へ直接アップロード。アップロード後は Operation の完了を待機し、成功時にファイル一覧へ追加。失敗した場合はアップロード直後のローカルファイルを即時削除し、再試行が可能。

### 4. 手動回答の登録
「チャットログ」から任意の質問の「手動回答登録」フォームに質問パターンと回答を記入し登録。登録済み回答は「手動回答」メニューで確認・削除・有効化/無効化できます。

### 5. ファイル / ストアの削除
個別ファイル削除では、Gemini 上の Document と `chatbot_gemini_files` のエントリ、ローカルのアップロードファイル（`wp_handle_upload()` によって保存された一時ファイル）を順に削除します。全削除ではリモート削除成功→ローカルファイル削除→キャッシュクリアの順で実行し、部分的失敗時もリモート／ローカル状態の整合性を保ちます。

## フロントエンドへの配置

ショートコードをページに埋め込むだけで利用できます：

```
[gemini_chatbot]
```

UI はレスポンシブ。Gemini あてのリクエストでは API 制限がかかった際に自動的にフォームを非表示にし「現在混雑中です」と案内します。

## 運用・注意事項

* API レートリミット・課金を常に確認。429/503 でトランジェントが設定され、自動的に再試行まで待機。
* アップロード後の処理失敗や部分的削除が起きても、ローカルファイルと `chatbot_gemini_files` の整合性を保つよう設計。
* アンインストール時には `uninstall.php` が実行され、設定・Gemini 上のストア/ファイル・カスタムテーブルをすべて削除します。
