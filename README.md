# Gemini File Search Chatbot Plugin

WordPressサイトにGoogle Gemini API (v1beta) のFile Search機能を利用したRAGチャットボットを導入するプラグインです。
PDFなどのドキュメントを管理画面からアップロードし、その内容に基づいてAIが回答します。また、手動で登録したFAQ回答を優先的に使用する機能も備えています。

## 機能

*   **RAG (Retrieval-Augmented Generation) チャット**: アップロードされたドキュメントを検索し、その内容を基に回答を生成します。
*   **Google Gemini API (gemini-2.5-flash) 対応**: 最新のGeminiモデルを使用し、高速かつ高精度な回答を実現。
*   **管理画面機能**:
    *   **設定**: APIキーの保存、File Search Storeの作成・削除。
    *   **アップロード**: PDF等のファイルをGemini Storeへ直接アップロード（REST API経由）。
    *   **チャットログ**: ユーザーとの会話履歴の閲覧、未回答質問のフィルタリング。
    *   **手動回答**: 特定の質問に対する固定回答の登録・管理。
*   **手動回答の自動選択**: Geminiを使用して、ユーザーの質問に最も適した手動回答を自動で選択します。適当なものがない場合はRAGによる回答へフォールバックします。
*   **API制限ハンドリング**: APIのレートリミット（429/503エラー）発生時に、一時的に利用を制限し、ユーザーフレンドリーなメッセージを表示します。
*   **セッション管理**: Cookieを使用した匿名ユーザーのセッション維持。

## 必要要件

*   WordPress 6.0以上
*   PHP 7.4以上
*   Google Cloud Platform アカウントと Gemini API キー (Gemini APIへのアクセス権限)

## インストール

1.  リポジトリをクローンするか、ZIPファイルをダウンロードして `wp-content/plugins/chatbot` に配置します。
2.  WordPress管理画面の「プラグイン」メニューから「Gemini File Search Chatbot」を有効化します。
    *   有効化時に必要なデータベーステーブルが自動作成されます。

## 設定方法

1.  **APIキーの設定**:
    *   管理画面 > **Gemini Chatbot** > **設定** に移動します。
    *   Google AI Studio等で取得した Gemini APIキーを入力し、「保存」をクリックします。
2.  **ストアの作成**:
    *   **ストア管理** タブで「新規ストア作成」をクリックし、任意の名前（例: `mysite-store`）を入力して作成します。
    *   作成されたストアを選択し、「保存」をクリックしてアクティブなストアとして設定します。
3.  **ファイルのアップロード**:
    *   **ファイルアップロード** タブで、回答のソースとなるファイル（PDF等）を選択し、「アップロード」をクリックします。
    *   アップロードされたファイルはGeminiのFile Search Storeに追加され、即座に検索対象となります。

## 使い方（フロントエンド）

任意の固定ページや投稿に以下のショートコードを記述してください。

```
[gemini_chatbot]
```

チャットウィンドウが表示され、ユーザーは質問を入力できます。
UIはレスポンシブ対応しており、PC・スマホ問わず利用可能です。

## 手動回答の登録（FAQ）

1.  管理画面 > **Gemini Chatbot** > **チャットログ** を確認します。
2.  ログ一覧から、手動回答を登録したい質問の「手動回答登録」フォームに入力し、「登録」ボタンを押します。
    *   **質問パターン**: ユーザーが入力しそうな質問の表記揺れ（AIが意味的に判断するため、代表的な質問文でOK）。
    *   **回答**: 返したい固定の回答内容。
3.  登録された回答は **手動回答** メニューで確認・削除できます。

## データベース構造

プラグイン有効化時に以下のカスタムテーブルを作成します（プレフィックス `wp_` は環境依存）。

*   `wp_chat_sessions`: チャットセッション情報（ユーザー識別、IPハッシュ等）
*   `wp_chat_messages`: チャットの会話ログ（質問、回答、使用モデル、レイテンシ等）
*   `wp_manual_answers`: 手動回答データ

## アンインストール時の挙動

プラグインを削除（アンインストール）すると、`uninstall.php` が実行され、以下のデータが完全に削除されます。**ご注意ください。**

*   プラグインの設定（APIキーなど）
*   Google Gemini上のStoreおよびアップロードされた全ファイル（リモート削除）
*   データベースのカスタムテーブル（ログ、手動回答含む）

## 注意事項

*   Google Gemini APIの利用料金やレートリミット（無料枠の制限など）にご注意ください。
*   API制限（503/429エラー）を検知すると、60秒間チャット機能を一時停止し「混雑中」のメッセージを表示する安全装置が組み込まれています。
*   プラグイン無効化時には外部のアップデートチェックを行わないように設定されています（`Update URI: false`）。
